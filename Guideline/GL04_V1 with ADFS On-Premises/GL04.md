## Mô tả
Test case: Tích hợp Vision One với ADFS On-Premises
Vision One hỗ trợ tích hợp IAM với ADFS on-premies. Yêu cầu bắt buộc
-	Có sẵn Active Directory và đã tích hợp ở bài test trên
-	Có sẵn ADFS

## Các bước thực hiện
1.	Tham khảo hướng dẫn chi tiết tại: https://www.docs.trendmicro.com/en-us/enterprise/trend-vision-one/administrative-setti/saml-single-sign-on/configuring-saml-sin/configuring-active-d.aspx
2.	Test với SAML account

Note: có thể tham khảo file **./MS_Cài đặt ADFS và cấu hình_v1.pdf**

## Kết quả
Cấu hình khai báo trên ADFS
Click AD FS in the left navigation, and under the Action area on the right, click **Add Relying Party Trust....**

![alt text](Image/image.png)

On the Select Data Source tab, select **Import data about the relying party from a file**, click Browse to select the **metadata file** you obtain from Trend Vision One; then, click Next.

![alt text](Image/image-1.png)

![alt text](Image/image-2.png)

On the Configure Multi-factor Authentication Now? tab, leave Multifactor Authentication at default and click Next. (IGNORE)
On the Choose Issuance Authorization Rules tab, select Permit all users to access this relying party and click Next.

![alt text](Image/image-3.png)

On the Ready to Add Trust tab, click Next.

![alt text](Image/image-4.png)

On the Finish tab, select Open the Edit Claim Rules dialog for this relying party trust when the wizard closes and click Close. 
The Edit Claim Rules screen appears.

![alt text](Image/image-5.png)  ![alt text](Image/image-6.png)

Complete settings on each tab of the **Add Transform Claim Rule Wizard** screen. 
On the Choose Rule Type tab, select **Send LDAP Attributes as Claims** from the Claim rule template drop-down list, and click **Next**.

![alt text](Image/image-7.png)

On the Configure Claim Rule tab, specify a claim rule name in the Claim rule name text box, and **select Active Directory** from the Attribute store drop-down list.
Select the following LDAP attributes and specify an outgoing claim type for each attribute: select **E-Mail-Addresses** and set it to **E-Mail-Address**; select **User-Principal-Name** and set it to **Name**.

![alt text](Image/image-8.png)

Click Finish.

![alt text](Image/image-9.png)

•  Click Add Rule.... 
•  Complete settings on each tab of the **Add Transform Claim Rule Wizard** screen. 
On the Choose Rule Type tab, select **Transform an Incoming Claim** from the Claim rule template drop-down list, and click Next. 

![alt text](Image/image-10.png)

On the Configure Claim Rule tab, specify a claim rule name in the Claim rule name text box, and select or type **E-Mail Address** for **Incoming claim type**, **Name ID** for **Outgoing claim type**, and **Email** for **Outgoing name ID format**.
•  Select **Pass through all claim values**, and click Finish.

![alt text](Image/image-11.png)

![alt text](Image/image-12.png)

Collect the single sign-on URL and export the Identity Provider metadata for ADFS.
•  On the ADFS management console, go to ADFS > Service > Endpoints.
•  In the right pane, under Endpoints > Metadata, in the Federation Metadata row, copy the URL path.

![alt text](Image/image-13.png)

![alt text](Image/image-14.png)

Add the host name of the AD FS computer to the URL path that you copied.
Example: https://adfs.trendmicro-one.com/FederationMetadata/2007-06/FederationMetadata.xml
•  To retrieve the Identity Provider metadata, use a web browser to navigate to the complete URL that you obtained in the previous step. 
•  Save the Identity Provider metadata file as an XML file.

![alt text](Image/image-15.png)

Import this metadata file to Trend Vision One.

![alt text](Image/image-16.png)

Kiểm tra bằng cách tạo một account SAML đăng nhập vào V1. Lưu ý: domain này là duy nhất trên hệ thống Trend Micro Vision One. Nếu có vấn đề thì có thể tạo một UPN mới trên AD, tạo user và thử lại

![alt text](Image/image-17.png)

Kiểm tra email trên AD đảm bảo user đã khai báo

![alt text](Image/image-18.png)

Đảm bảo email đã phù hợp

![alt text](Image/image-19.png)

![alt text](Image/image-20.png)

![alt text](Image/image-21.png)

![alt text](Image/image-22.png)

Test với Zero Trust Internet Access nếu đã setup

![alt text](Image/image-23.png)  ![alt text](Image/image-24.png)
